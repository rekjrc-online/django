{% extends "base.html" %}
{% load widget_tweaks %}
{% block content %}

<div class="post card" style="margin-top:20px; padding:0px; text-align:center;">
    <h3>Build Club</h3>
</div>

<!-- Profile summary section -->
{% include "profiles/profile_header.html" %}

<div class="post card" style="padding: 10px; max-width: 800px; margin-left:auto; margin-right:auto;">
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}

        <h4>Locations</h4>
        {{ location_formset.management_form }}

        <table id="locations-table" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr>
                    <th style="text-align:left; padding:5px;">Location</th>
                    <th style="text-align:center; padding:5px;">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for form in location_formset.forms %}
                <tr>
                    <td style="padding:5px; width:100%;">{{ form.location }}</td>
                    <td style="text-align:center; padding:5px;">
                        <button type="button" class="remove-location-btn" style="padding:4px 8px;">-</button>
                    </td>
                </tr>
                {% endfor %}

                <!-- Empty form template (hidden) -->
                <tr class="empty-form" style="display:none;">
                    <td style="padding:5px; width:100%;">
                        {{ location_formset.empty_form.location }}
                    </td>
                    <td style="text-align:center; padding:5px;">
                        <button type="button" id="pending" style="padding:4px 8px;">+</button>
                    </td>
                </tr>
            </tbody>
        </table>

        <button type="submit"
            style="width: 100%; margin-top: 15px; padding: 10px; background-color:#1da1f2; color:white; border:none; border-radius:5px; cursor:pointer;">
            Save Club
        </button>
    </form>
    <br>
</div>

<style>
.location-dropdown {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}
</style>

<script>
function addLocationRow(event) {
    console.log('--- addLocationRow triggered ---');

    const tableBody = document.querySelector('#locations-table tbody');
    console.log('tableBody:', tableBody);

    const totalForms = document.getElementById('id_location_set-TOTAL_FORMS');
    console.log('totalForms element:', totalForms);

    const formIdx = parseInt(totalForms.value);
    console.log('Current form index:', formIdx);

    // Identify current row and validate
    const currentRow = event.target.closest('tr');
    console.log('Current row:', currentRow);

    const selectInput = currentRow.querySelector('select');
    console.log('Select input found:', selectInput);

    if (selectInput && !selectInput.value) {
        console.log('No value selected â€” skipping new row creation.');
        return;
    }

    // Clone empty form
    const emptyTemplate = document.querySelector('.empty-form');
    console.log('Empty form template:', emptyTemplate);

    const newRow = emptyTemplate.cloneNode(true);
    newRow.classList.remove('empty-form');
    newRow.style.display = '';
    newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, formIdx);
    console.log('New row created:', newRow);

    // Wire up the new "+" button
    const btn = newRow.querySelector('#pending');
    if (btn) {
        btn.id = 'add-location';
        btn.addEventListener('click', addLocationRow);
        console.log('Wired new add-location button:', btn);
    } else {
        console.warn('No pending button found in new row!');
    }

    // Convert clicked + to a - button
    const btn2 = event.target;
    console.log('Original clicked button:', btn2);

    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'remove-location-btn';
    removeBtn.textContent = '-';
    removeBtn.style.padding = '4px 8px';
    removeBtn.addEventListener('click', (e) => {
        console.log('Remove button clicked. Removing row:', e.target.closest('tr'));
        e.target.closest('tr').remove();
    });

    console.log('Replacing + button with - button:', removeBtn);
    btn2.replaceWith(removeBtn);

    // Append the new row
    tableBody.appendChild(newRow);
    console.log('Appended new row to tableBody.');

    // Increment the management form count
    totalForms.value = formIdx + 1;
    console.log('Updated totalForms value:', totalForms.value);

    console.log('--- addLocationRow complete ---');
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('DOM fully loaded.');
    const addBtn = document.getElementById('pending');
    console.log('Initial add button:', addBtn);

    if (addBtn) {
        addBtn.addEventListener('click', addLocationRow);
        console.log('Initial add-location event wired.');
    } else {
        console.warn('No #pending button found at DOM load!');
    }
});
</script>

{% endblock %}
