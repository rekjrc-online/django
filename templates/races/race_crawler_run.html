{% extends "base.html" %}
{% block content %}
<h2>Crawler Run: {{ racedriver.profile.displayname }}</h2>

<style>
.lcd-display {
    font-family: 'Courier New', monospace;
    font-size: 3em;
    background-color: #111;
    color: #39ff14;
    padding: 10px 20px;
    border-radius: 10px;
    text-align: right;
    width: 250px;
    margin: 10px auto;
    box-shadow: 0 0 20px #0f0 inset;
}
.button-grid {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
}
.button-grid button {
    padding: 10px 20px;
    font-size: 1em;
    border: none;
    border-radius: 8px;
    background-color: #222;
    color: white;
    cursor: pointer;
}
.button-grid button:hover {
    background-color: #333;
}
</style>

<div style="text-align:center;">
    <div>
        <div class="lcd-display" id="elapsedDisplay">00:00.00</div>
        <small>Elapsed Time</small>
    </div>
    <div>
        <div class="lcd-display" id="totalDisplay">00:00.00</div>
        <small>Total Time (with Penalties)</small>
    </div>
</div>

<form method="post" id="runForm" style="text-align:center;">
    {% csrf_token %}
    <input type="hidden" id="elapsed_time" name="elapsed_time" value="">
    <input type="hidden" id="penalty_time" name="penalty_time" value="">
    
    <div class="button-grid">
        <button type="button" id="startStopBtn">Start</button>
        <button type="button" id="penalty1">+1s</button>
        <button type="button" id="penalty5">+5s</button>
        <button type="button" id="penalty10">+10s</button>
        <button type="submit" id="submitBtn">Submit</button>
    </div>
</form>

<script>
let startTime = 0;
let elapsed = 0;
let penalty = 0;
let running = false;
let interval;

const elapsedDisplay = document.getElementById('elapsedDisplay');
const totalDisplay = document.getElementById('totalDisplay');
const startStopBtn = document.getElementById('startStopBtn');
const elapsedInput = document.getElementById('elapsed_time');
const penaltyInput = document.getElementById('penalty_time');

function formatTime(sec) {
    const minutes = Math.floor(sec / 60);
    const seconds = Math.floor(sec % 60);
    const hundredths = Math.floor((sec % 1) * 100);
    return `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}.${String(hundredths).padStart(2,'0')}`;
}

function updateDisplays() {
    const now = running ? (Date.now() - startTime) / 1000 + elapsed : elapsed;
    elapsedDisplay.textContent = formatTime(now);
    totalDisplay.textContent = formatTime(now + penalty);
    elapsedInput.value = now.toFixed(2);
    penaltyInput.value = penalty.toFixed(2);
}

startStopBtn.addEventListener('click', () => {
    if (!running) {
        running = true;
        startTime = Date.now();
        interval = setInterval(updateDisplays, 50);
        startStopBtn.textContent = 'Pause';
    } else {
        running = false;
        clearInterval(interval);
        elapsed += (Date.now() - startTime) / 1000;
        startStopBtn.textContent = 'Start';
        updateDisplays();
    }
});

document.getElementById('penalty1').addEventListener('click', () => { penalty += 1; updateDisplays(); });
document.getElementById('penalty5').addEventListener('click', () => { penalty += 5; updateDisplays(); });
document.getElementById('penalty10').addEventListener('click', () => { penalty += 10; updateDisplays(); });
</script>

{% endblock %}
