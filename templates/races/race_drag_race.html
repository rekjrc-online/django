{% extends "base.html" %}
{% block content %}

<div class="page_header">Run Drag Race</div>

<div class="post card">
    <center>
        <form method="post" id="drag-race-form">
            {% csrf_token %}
            <table cellpadding="0" cellspacing="0" width="100%" class="drag-race-table">
                <thead>
                    <tr>
                        <th>Round</th>
                        <th>Racers</th>
                    </tr>
                    <tr><td><br /></td></tr>
                </thead>
                <tbody>
                    {% for round in rounds %}
                        <tr>
                            <td align="center">{{ round.round_number }}</td>
                            <td>
                                {% if round.winner %}
                                    <div class="btn-wrapper">
                                        <button type="button" class="winner-btn active">
                                            {% if round.winner == round.model1 %}
                                                {{ round.model1.driver.displayname }} -
                                                {{ round.model1.model.displayname }}
                                            {% else %}
                                                {{ round.model2.driver.displayname }} -
                                                {{ round.model2.model.displayname }}
                                            {% endif %}
                                        </button>
                                    </div>
                                {% else %}
                                    {% if round.model1 %}
                                        <div class="btn-wrapper">
                                            <button type="button" class="winner-btn {% if round.winner == round.model1 %}active{% endif %}"
                                                    data-round-id="{{ round.id }}" 
                                                    data-model-id="{{ round.model1.id }}">
                                                {{ round.model1.driver.displayname }} -
                                                {{ round.model1.model.displayname }}
                                            </button>
                                        </div>
                                    {% else %}
                                        -bye-
                                    {% endif %}
                                    <p>
                                    {% if round.model2 %}
                                        <div class="btn-wrapper">
                                            <button type="button" class="winner-btn {% if round.winner == round.model2 %}active{% endif %}"
                                                    data-round-id="{{ round.id }}" 
                                                    data-model-id="{{ round.model2.id }}">
                                                {{ round.model2.driver.displayname }} -
                                                {{ round.model2.model.displayname }}
                                            </button>
                                        </div>
                                    {% else %}
                                        -bye-
                                    {% endif %}
                                {% endif %}
                            </td>
                            <!-- Hidden input to store winner -->
                            <input type="hidden" name="winner_{{ round.id }}" id="winner_{{ round.id }}"
                                value="{% if round.winner %}{{ round.winner.id }}{% endif %}">
                        </tr>
                        <tr><td><br /></td></tr>
                    {% endfor %}
                </tbody>
            </table>
            <p>
            <div>
                <button type="submit" class="submit-btn">
                    Save Winners
                </button>
            </div>
        </form>
        <br />
    </center>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const buttons = document.querySelectorAll('.winner-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', (event) => {
                if (btn.disabled) return;
                const roundId = btn.dataset.roundId;
                const modelId = btn.dataset.modelId;
                const hiddenInput = document.getElementById(`winner_${roundId}`);
                hiddenInput.value = modelId;
                document.querySelectorAll(`.winner-btn[data-round-id='${roundId}']`)
                    .forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
    });
</script>

{% endblock %}
