{% extends "base.html" %}
{% block content %}

<!-- Profile summary section -->
{% include "profiles/profile_header.html" %}

<div class="post card" style="padding:10px;">
    <div style="margin-top:15px;">
        {% include "races/race_form.html" %}
    </div>
</div>

<div class="post card" style="padding:10px;">
    {% if attribute_formset %}
        <h3>Attributes</h3>
        {{ attribute_formset.management_form }}

        <table id="attributes-table" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr>
                    <th style="text-align:left; padding:5px;">Attribute</th>
                    <th style="text-align:left; padding:5px;">Value</th>
                    <th style="padding:5px;">Delete</th>
                </tr>
            </thead>
            <tbody>
                {% for form in attribute_formset.forms %}
                    {{ form.id }}
                    <tr>
                        <td style="padding:5px;">{{ form.attribute }}</td>
                        <td style="padding:5px;">{{ form.value }}</td>
                        <td style="text-align:center; padding:5px;">
                            {% if form.instance.pk %}
                                {{ form.DELETE }}
                            {% else %}
                                <button type="button" id="add-attribute" style="padding: 2px; background-color:#1da1f2; color:white; border:none; border-radius:5px; cursor:pointer; width:30px;">+</button>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                <tr class="empty-form" style="display:none;">
                    <td style="padding:5px;">{{ attribute_formset.empty_form.attribute }}</td>
                    <td style="padding:5px;">{{ attribute_formset.empty_form.value }}</td>
                    <td style="text-align:center; padding:5px;">
                        <button type="button" id="pending" style="padding: 2px; background-color:#1da1f2; color:white; border:none; border-radius:5px; cursor:pointer; width:30px;">+</button>
                    </td>
                </tr>
            </tbody>
        </table>

        <script>
            function addAttributeRow(event) {
                const tableBody = document.querySelector('#attributes-table tbody');
                const totalForms = document.getElementById('id_attributes-TOTAL_FORMS');
                const formIdx = parseInt(totalForms.value);
                const currentRow = event.target.closest('tr');
                const attributeSelect = currentRow.querySelector('select');
                const valueInput = currentRow.querySelector('input');
                if (!attributeSelect.value || !valueInput.value.trim()) {
                    return;
                }
                const newRow = document.querySelector('.empty-form').cloneNode(true);
                newRow.classList.remove('empty-form');
                newRow.style.display = '';
                newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, formIdx);
                const btn = newRow.querySelector('#pending');
                if (btn) {
                    btn.id = 'add-attribute';
                    btn.addEventListener('click', addAttributeRow);
                }
                tableBody.appendChild(newRow);
                totalForms.value = formIdx + 1;
                const btn2 = event.target;
                const textNode = document.createElement('span');
                textNode.textContent = "Add";
                btn2.replaceWith(textNode);
            }
            document.addEventListener('DOMContentLoaded', () => {
                const addBtn = document.getElementById('add-attribute');
                if (addBtn) {
                    addBtn.addEventListener('click', addAttributeRow);
                }
            });
        </script>
    {% endif %}
    <div style="text-align:right; margin-top:15px;">
        <button type="submit"
            style="padding:8px 20px; background-color:#1da1f2; color:white; border:none; border-radius:5px; cursor:pointer;">
            Save Race
        </button>
    </div>
    <br />
</div>

<div style="text-align:center; margin-top:20px;">
    <a href="{% url 'races:race_list' %}">Back To Race List</a>
</div>

<br /><br /><br /><br />

{% endblock %}
